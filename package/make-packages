#/bin/bash
set -x

# Install
mv konstructs /usr/local/bin/konstructs-client
mkdir -p /usr/local/share/konstructs-client/{textures,shaders}
mkdir -p /usr/share/applications/
cp -r textures/* /usr/local/share/konstructs-client/textures
cp -r shaders/* /usr/local/share/konstructs-client/shaders
cp package/konstructs-client.desktop /usr/share/applications/konstructs-client.desktop

# Fetch the remote tags
git fetch --tags

# Travis only fetch the 50 last commits, this fixes that.
git fetch --unshallow

# Make deb package
fpm -s dir -t deb \
  -v $(git describe --abbrev=0 --tags | tr -d v) \
  --iteration ${TRAVIS_BUILD_NUMBER} \
  --license MIT \
  --depends libglfw2 \
  --depends zlib1g \
  --maintainer "Stefan Berggren <nsg@nsg.cc>" \
  --url https://github.com/konstructs/client \
  -n konstructs-client \
  /usr/local/bin/konstructs-client \
  /usr/local/share/konstructs-client/textures \
  /usr/local/share/konstructs-client/shaders \
  /usr/share/applications/konstructs-client.desktop

# Make rpm package
fpm -s dir -t rpm \
  -v $(git describe --abbrev=0 --tags | tr -d v) \
  --iteration ${TRAVIS_BUILD_NUMBER} \
  --license MIT \
  --depends libglfw2 \
  --depends zlib1g \
  --maintainer "Stefan Berggren <nsg@nsg.cc>" \
  --url https://github.com/konstructs/client \
  -n konstructs-client \
  /usr/local/bin/konstructs-client \
  /usr/local/share/konstructs-client/textures \
  /usr/local/share/konstructs-client/shaders \
  /usr/share/applications/konstructs-client.desktop
